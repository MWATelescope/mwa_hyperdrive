---
name: Release

# Do this on every tagged commit
on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  build-linux-release:
    name: Build release for Linux
    runs-on: ubuntu-18.04

    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            tzdata \
            build-essential \
            pkg-config \
            cmake \
            curl \
            git \
            libfreetype-dev \
            libexpat1-dev \
            ;
        env:
          DEBIAN_FRONTEND: noninteractive

      - name: Install CUDA
        uses: Jimver/cuda-toolkit@v0.2.5
        with:
          cuda: '11.0.0'

    - name: Build
      run: |
        curl https://raw.githubusercontent.com/HDFGroup/hdf5/develop/COPYING -o COPYING-hdf5
        curl https://raw.githubusercontent.com/liberfa/erfa/master/LICENSE -o LICENSE-erfa
        curl https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/License.txt -o LICENSE-cfitsio
        cp .github/workflows/releases-readme.md README.md

        cargo build --release --locked --features=cuda,all-static
        mv target/release/hyperdrive .
        tar -acvf mwa_hyperbeam-$(git describe --tags)-Linux-x86-64-v3.tar.gz \
        LICENSE COPYING-hdf5 LICENSE-erfa LICENSE-cfitsio README.md \
        mwa_hyperdrive
      env:
        RUSTFLAGS="-C target-cpu=x86-64-v3"

    - name: Upload tarball
      uses: actions/upload-artifact@v2
      with:
        name: linux.tar.gz
        path: "*.tar.gz"
        if-no-files-found: error
