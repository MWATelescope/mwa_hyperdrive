<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Coordinate systems - mwa_hyperdrive documentation</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="mwa_hyperdrive documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././theme/css/mdbook-admonish.css">
        <link rel="stylesheet" href=".././mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Installation</li><li class="chapter-item expanded "><a href="installation/intro.html"><strong aria-hidden="true">1.</strong> How do I install hyperdrive?</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="installation/pre_compiled.html"><strong aria-hidden="true">1.1.</strong> Pre-compiled</a></li><li class="chapter-item "><a href="installation/from_source.html"><strong aria-hidden="true">1.2.</strong> From source</a></li><li class="chapter-item "><a href="installation/post.html"><strong aria-hidden="true">1.3.</strong> Post installation</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="user/intro.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="user/help.html"><strong aria-hidden="true">3.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="user/di_cal/intro.html"><strong aria-hidden="true">4.</strong> DI calibration</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="user/di_cal/tutorial.html"><strong aria-hidden="true">4.1.</strong> Tutorial</a></li><li class="chapter-item "><a href="user/di_cal/simple.html"><strong aria-hidden="true">4.2.</strong> Simple usage</a></li><li class="chapter-item "><a href="user/di_cal/out_calibrated.html"><strong aria-hidden="true">4.3.</strong> Getting calibrated data</a></li><li class="chapter-item "><div><strong aria-hidden="true">4.4.</strong> Advanced usage</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="user/di_cal/advanced/time_varying.html"><strong aria-hidden="true">4.4.1.</strong> Varying solutions over time</a></li></ol></li><li class="chapter-item "><a href="user/di_cal/garrawarla.html"><strong aria-hidden="true">4.5.</strong> Usage on garrawarla</a></li><li class="chapter-item "><a href="user/di_cal/how_does_it_work.html"><strong aria-hidden="true">4.6.</strong> How does it work?</a></li></ol></li><li class="chapter-item expanded "><a href="user/solutions_apply/intro.html"><strong aria-hidden="true">5.</strong> Apply solutions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="user/solutions_apply/simple.html"><strong aria-hidden="true">5.1.</strong> Simple usage</a></li></ol></li><li class="chapter-item expanded "><a href="user/plotting.html"><strong aria-hidden="true">6.</strong> Plot solutions</a></li><li class="chapter-item expanded "><a href="user/vis_convert/intro.html"><strong aria-hidden="true">7.</strong> Convert visibilities</a></li><li class="chapter-item expanded "><a href="user/vis_simulate/intro.html"><strong aria-hidden="true">8.</strong> Simulate visibilities</a></li><li class="chapter-item expanded "><a href="user/vis_subtract/intro.html"><strong aria-hidden="true">9.</strong> Subtract visibilities</a></li><li class="chapter-item expanded "><a href="user/beam.html"><strong aria-hidden="true">10.</strong> Get beam responses</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Definitions and Concepts</li><li class="chapter-item expanded "><a href="defs/pols.html"><strong aria-hidden="true">11.</strong> Polarisations</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Supported visibility formats</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/vis_formats_read.html"><strong aria-hidden="true">12.1.</strong> Read</a></li><li class="chapter-item "><a href="defs/vis_formats_write.html"><strong aria-hidden="true">12.2.</strong> Write</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> MWA-specific details</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/mwa/metafits.html"><strong aria-hidden="true">13.1.</strong> Metafits files</a></li><li class="chapter-item "><a href="defs/mwa/delays.html"><strong aria-hidden="true">13.2.</strong> Dipole delays</a></li><li class="chapter-item "><a href="defs/mwa/dead_dipoles.html"><strong aria-hidden="true">13.3.</strong> Dead dipoles</a></li><li class="chapter-item "><a href="defs/mwa/mwaf.html"><strong aria-hidden="true">13.4.</strong> mwaf flag files</a></li><li class="chapter-item "><a href="defs/mwa/corrections.html"><strong aria-hidden="true">13.5.</strong> Raw data corrections</a></li><li class="chapter-item "><a href="defs/mwa/picket_fence.html"><strong aria-hidden="true">13.6.</strong> Picket fence obs</a></li><li class="chapter-item "><a href="defs/mwa/mwalib.html"><strong aria-hidden="true">13.7.</strong> mwalib</a></li></ol></li><li class="chapter-item expanded "><a href="defs/source_lists.html"><strong aria-hidden="true">14.</strong> Sky-model source lists</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/fd_types.html"><strong aria-hidden="true">14.1.</strong> Flux-density types</a></li><li class="chapter-item "><a href="defs/source_list_hyperdrive.html"><strong aria-hidden="true">14.2.</strong> hyperdrive format</a></li><li class="chapter-item "><a href="defs/source_list_ao.html"><strong aria-hidden="true">14.3.</strong> André Offringa (ao) format</a></li><li class="chapter-item "><a href="defs/source_list_rts.html"><strong aria-hidden="true">14.4.</strong> RTS format</a></li><li class="chapter-item "><a href="defs/source_list_fits.html"><strong aria-hidden="true">14.5.</strong> FITS format</a></li></ol></li><li class="chapter-item expanded "><a href="defs/cal_sols.html"><strong aria-hidden="true">15.</strong> Calibration solutions file formats</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/cal_sols_hyp.html"><strong aria-hidden="true">15.1.</strong> hyperdrive format</a></li><li class="chapter-item "><a href="defs/cal_sols_ao.html"><strong aria-hidden="true">15.2.</strong> André Offringa (ao) format</a></li><li class="chapter-item "><a href="defs/cal_sols_rts.html"><strong aria-hidden="true">15.3.</strong> RTS format</a></li></ol></li><li class="chapter-item expanded "><a href="defs/beam.html"><strong aria-hidden="true">16.</strong> Beam responses</a></li><li class="chapter-item expanded "><a href="defs/modelling/intro.html"><strong aria-hidden="true">17.</strong> Modelling visibilities</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/modelling/rime.html"><strong aria-hidden="true">17.1.</strong> Measurement equation</a></li><li class="chapter-item "><a href="defs/modelling/estimating.html"><strong aria-hidden="true">17.2.</strong> Estimating flux densities</a></li></ol></li><li class="chapter-item expanded "><a href="defs/coords.html"><strong aria-hidden="true">18.</strong> Coordinate systems</a></li><li class="chapter-item expanded "><a href="defs/dut1.html"><strong aria-hidden="true">19.</strong> DUT1</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Terminology</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="defs/blocks.html"><strong aria-hidden="true">20.1.</strong> Timeblocks and chanblocks</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Developer Guide</li><li class="chapter-item expanded "><a href="dev/ndarray.html"><strong aria-hidden="true">21.</strong> Multiple-dimension arrays (ndarray)</a></li><li class="chapter-item expanded "><a href="dev/vec1.html"><strong aria-hidden="true">22.</strong> Non-empty vectors (vec1)</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">mwa_hyperdrive documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MWATelescope/mwa_hyperdrive" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="coordinate-systems"><a class="header" href="#coordinate-systems">Coordinate systems</a></h1>
<h2 id="antennatilestationarray-coordinates"><a class="header" href="#antennatilestationarray-coordinates">Antenna/tile/station/array coordinates</a></h2>
<p>In measurement sets and uvfits files, antennas/tiles/stations usually have their
positions recorded in the
<a href="https://en.wikipedia.org/wiki/International_Terrestrial_Reference_System_and_Frame">ITRF</a>
frame (internally we refer to this as "geocentric XYZ"). There's also a
"geodetic XYZ" frame; an example of this is <a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS_84">WGS
84</a> (which we assume
everywhere when converting, as it's the current best ellipsoid). Finally,
there's also an "East North Height" coordinate system.</p>
<p>To calculate UVW baseline coordinates, geodetic XYZ coordinates are
required<sup class="footnote-reference"><a href="#1">1</a></sup>. Therefore, various coordinate conversions are required to obtain
UVWs. The conversion between all of these systems is briefly described below.
The relevant code lives within <a href="https://github.com/MWATelescope/Marlu"><code>Marlu</code></a>.</p>
<h2 id="itrf-and-geocentric-xyz"><a class="header" href="#itrf-and-geocentric-xyz">ITRF and "geocentric XYZ"</a></h2>
<p>As the name implies, this coordinate system uses the centre of the Earth as a
reference. To convert between geocentric and geodetic, an array position is
required (i.e. the "average" location on the Earth of the instrument collecting
visibilities). When all antenna positions are geocentric, the array position is
given by the mean antenna position.</p>
<p>Measurement sets indicate the usage of ITRF with the "MEASURE_REFERENCE" keyword
attached to the POSITION column of an ANTENNA table (value "ITRF").</p>
<p>The <a href="https://library.nrao.edu/public/memos/aips/memos/AIPSM_117.pdf">uvfits
standard</a> states
that only supported frame is "ITRF", and <code>hyperdrive</code> assumes that only ITRF is
used. However, CASA/casacore seem to write out antenna positions incorrectly;
the positions look like what you would find in an equivalent measurement set.
The incorrect behaviour is detected and accounted for.</p>
<h2 id="geodetic-xyz"><a class="header" href="#geodetic-xyz">"Geodetic XYZ"</a></h2>
<p>This coordinate system is similar to geocentric, but uses an array position as
its reference.</p>
<p>Measurement sets support the WGS 84 frame, again with the "MEASURE_REFERENCE"
keyword attached to the POSITION column of an ANTENNA table (value "WGS84").
However, <code>hyperdrive</code> currently does not check if geodetic positions are used;
it instead just assumes geocentric.</p>
<p>When read literally, the antenna positions in a uvfits file ("STABXYZ" column of
the "AIPS AN" HDU) <em>should</em> be geodetic, not counting the aforementioned
casacore bug.</p>
<h2 id="east-north-height-enh"><a class="header" href="#east-north-height-enh">East North Height (ENH)</a></h2>
<p>MWA tiles positions are listed in <a href="../defs/mwa/metafits.html">metafits</a> files with
the ENH coordinate system. Currently, ENH coordinates are converted to geodetic
XYZ with the following pseudocode:</p>
<pre><code class="language-python">x = -n * sin(latitude) + h * cos(latitude)
y = e
z = n * cos(latitude) + h * sin(latitude)
</code></pre>
<p>(I unfortunately don't know anything more about this system.)</p>
<h2 id="array-positions"><a class="header" href="#array-positions">Array positions</a></h2>
<p>Array positions can be found with the mean geocentric antenna positions, as is
the case with measurement sets, or with the <code>ARRAYX</code>, <code>ARRAYY</code> and <code>ARRAYZ</code> keys
in a uvfits file. However, <code>hyperdrive</code> allows the user to supply a custom array
position, which will be used in any conversions between provided antenna
positions and other coordinate systems as required.</p>
<p>For raw MWA data, no array position is supplied, so we assume a location for the
MWA. This is currently:</p>
<ul>
<li>Latitude: -0.4660608448386394 radians (or −26.70331941 degrees)</li>
<li>Longitude: 2.0362898668561042 radians (or 116.6708152 degrees)</li>
<li>Height: 377.827 metres</li>
</ul>
<h2 id="precession"><a class="header" href="#precession">Precession</a></h2>
<p>It is often necessary to precess antenna positions to the J2000 epoch, because:</p>
<ul>
<li>Measurement sets and uvfits expect their UVWs to be specified in the J2000 epoch; and</li>
<li>Sky model source lists are expected to be specified in the J2000 epoch.</li>
</ul>
<p><code>hyperdrive</code> performs precession on each timestep of input visibility data to
(hopefully) get UVWs as correct as possible.</p>
<p>The process to precess geodetic XYZs is too complicated to detail here, but the
code lives within <a href="https://github.com/MWATelescope/Marlu"><code>Marlu</code></a>. This code is
a re-write of old MWA code, and there appears to be no references on how or why
it works; any information is greatly appreciated!</p>
<h2 id="uvws"><a class="header" href="#uvws">UVWs</a></h2>
<p>A geodetic XYZ is converted to UVW using the following pseudocode:</p>
<pre><code class="language-python">s_ha = sin(phase_centre.hour_angle)
c_ha = cos(phase_centre.hour_angle)
s_dec = sin(phase_centre.declination)
c_dec = cos(phase_centre.declination)

u = s_ha * x + c_ha * y,
v = -s_dec * c_ha * x + s_dec * s_ha * y + c_dec * z,
w = c_dec * c_ha * x - c_dec * s_ha * y + s_dec * z,
</code></pre>
<p>Note that this is a UVW coordinate for an antenna. To get the proper baseline
UVW, a difference between two antennas' UVWs needs to be taken. The order of
this subtraction is important; <code>hyperdrive</code> uses the "antenna1 - antenna2"
convention. Software that reads data may need to conjugate visibilities if this
convention is different.</p>
<h3 id="further-reading"><a class="header" href="#further-reading">Further reading</a></h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/International_Terrestrial_Reference_System_and_Frame">https://en.wikipedia.org/wiki/International_Terrestrial_Reference_System_and_Frame</a></li>
<li><a href="https://en.wikipedia.org/wiki/World_Geodetic_System">https://en.wikipedia.org/wiki/World_Geodetic_System</a></li>
<li>The <a href="https://library.nrao.edu/public/memos/aips/memos/AIPSM_117.pdf">uvfits
standard</a></li>
<li><a href="https://casa.nrao.edu/Memos/CoordConvention.pdf">https://casa.nrao.edu/Memos/CoordConvention.pdf</a></li>
<li><a href="https://casa.nrao.edu/Memos/229.html#SECTION00042000000000000000">https://casa.nrao.edu/Memos/229.html#SECTION00042000000000000000</a></li>
</ul>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>If this isn't true, <em>please</em> file a <code>hyperdrive</code> issue.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../defs/modelling/estimating.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../defs/dut1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../defs/modelling/estimating.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../defs/dut1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>


    </body>
</html>
