<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Peel visibilities - mwa_hyperdrive documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="mwa_hyperdrive documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../././theme/css/mdbook-admonish.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">mwa_hyperdrive documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MWATelescope/mwa_hyperdrive" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="peel-visibilities"><a class="header" href="#peel-visibilities">Peel visibilities</a></h1>
<p><code>peel</code> can subtract the sky-model visibilities from calibrated data visibilities, and write them out like <a href="../vis_subtract/intro.html">vis-subtract</a>, but it additionally solves for and applies the direction dependent effects of the ionosphere.</p>
<div id="admonition-work-in-progress" class="admonition admonish-warning" role="note" aria-labelledby="admonition-work-in-progress-title">
<div class="admonition-title">
<div id="admonition-work-in-progress-title">
<p>Work in progress</p>
</div>
<a class="admonition-anchor-link" href="#admonition-work-in-progress"></a>
</div>
<div>
<p>Hyperdrive's <code>peel</code> implementation technically only performs ionospheric subtraction. For more on the distinction between the two, read on. Familiarity with the <code>vis-subtract</code> command is recommended.</p>
</div>
</div>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>From the images below, it's clear that peeling 100 sources, rather than directly subtracting them
results in a much cleaner image.</p>
<p><img src="unsubtracted.png" alt="unsubtracted visibilities" />
<img src="subtracted.png" alt="subtracted visibilities" />
<img src="peeled.png" alt="peeled visibilities" /></p>
<details>
<summary>Steps to reproduce the images above.</summary>
<p>The images above were generated using mwa-demo with the following <code>demo/00_env.sh</code></p>
<pre><code class="language-bash">export obsid=1321103688

# preprocessing
export freqres_khz=40
export timeres_s=2
# calibration: only use the 11th timestep from the raw files
export apply_args="--timesteps 10"
export dical_name="_t10"

# peeling
export num_sources=100
export iono_sources=100
export num_passes=1
export num_loops=1
export freq_average=80kHz
export time_average=8s
export iono_freq_average=1280kHz
export iono_time_average=8s
export uvw_min=50lambda
export uvw_max=300lambda
export short_baseline_sigma=40
export convergence=0.9

# imaging
export briggs=0.5
export size=8000
export scale=0.0035502
export niter=10000000
export nmiter=5
export wsclean_args="-multiscale-gain 0.15 -join-channels -channels-out 4 -save-source-list -fit-spectral-pol 2"

# generate the peeled visibilities
demo/09_peel.sh

# generate the subtracted visibilities
export iono_sources=0
export peel_prefix="sub_"
demo/09_peel.sh

# image everything
demo/07_img.sh
</code></pre>
</details>
<h2 id="ionospheric-subtraction"><a class="header" href="#ionospheric-subtraction">Ionospheric subtraction</a></h2>
<p>Light travels slower through regions of higher electron density, especially at lower frequencies. When light from a source passes through the ionosphere, it is refracted, causing a shift in the apparent position and brightness of the source. This shift varies with the direction of the source and can change over time.</p>
<p>Assuming the ionosphere is a thin screen with a slowly varying electron density, the direction and magnitude of the shift depend on the gradient of the electron density along the line of sight and scale with the square of the light's wavelength.</p>
<p>Ionospheric subtraction models the effect of the ionosphere on a given source using three parameters:</p>
<ul>
<li>The ionospheric offset vector (α, β), which is a constant of proportionality in front of λ², representing the shift in the source's apparent position in image space (l, m), such that l = αλ², m = βλ².</li>
<li>A gain (g), which captures any changes in the apparent brightness of the source.</li>
</ul>
<p>Hyperdrive solves for these ionospheric parameters for each source using the algorithm described in <a href="https://ieeexplore.ieee.org/document/4703504">Mitchell 2008</a> one timeblock at a time.</p>
<h3 id="algorithm"><a class="header" href="#algorithm">Algorithm</a></h3>
<p>The starting point (and end point) for ionospheric subtraction is the residual visibilities, which is the calibrated data with the ionospheric sky model subtracted. Initially, the ionospheric parameters of each source are not known, and so the sources are subtracted without any ionospheric corrections, but the solutions are usually improved in subsequent passes.</p>
<p>Looping over each source, the residuals are phased to the source's catalogue position, and the model for the source that was subtracted is added back in to the data. Let's call these visibilities the</p>
<p>First, all other sources in the sky-model are subtracted from the calibrated data, and the data is phased to the catalogue position of the source. The data can then be averaged to a lower resolution to improve performance. Finally, the ionospheric parameters are measured using the least-squares fit described in the paper.</p>
<h2 id="loop-parameters"><a class="header" href="#loop-parameters">Loop parameters</a></h2>
<p>In reality, the ionosphere is a complex, turbulent medium, and not all tiles see the same ionosphere so the algorithm includes several safeguards to prevent divergent solutions. Each source's offsets are calculated in a loop, with a convergence factor to reduce the step size as the solution approaches the correct value.</p>
<p>In the first pass of the algorithm, the ionospheric offsets are not known, and so the sources are not necessarily subtracted from their correct positions, but the solutions are usually improved in subsequent passes.</p>
<p><code>--num-loops</code> sets the maximum number of loops for each source, while <code>--num-passes</code> is the number of passes over all sources. Decreasing <code>--convergence</code> is one way to improve the quality of the solutions, but it will also increase the runtime.</p>
<h2 id="averaging"><a class="header" href="#averaging">Averaging</a></h2>
<p>hyperdrive reasons about visibilities at multiple resolutions:</p>
<ul>
<li>The input data's original resolution</li>
<li>The input data's resolution during reading ( <code>--time-average</code>, <code>--freq-average</code> )</li>
<li>The resolution of the ionospheric subtraction ( <code>--iono-time-average</code>, <code>--iono-freq-average</code> )</li>
<li>The resolution of the output visibilities ( <code>--output-vis-time-average</code>, <code>--output-vis-freq-average</code> )</li>
</ul>
<p>All of these resolutions are specified in seconds or Hz, and are multiples of the input data's resolution. If the resolution is 0, then all data are averaged together.</p>
<h2 id="weighting"><a class="header" href="#weighting">Weighting</a></h2>
<p>It is important to down-weight short baselines if your point-source sky model is missing diffuse information. The minimum uv-distance to include in the fit can be set with <code>--uvw-min</code>, and the maximum with <code>--uvw-max</code>. The default is to include all baselines &gt; 50λ.</p>
<p>hyperdrive also borrows from RTS, which used a gaussian weighting scheme to taper short baselines, <code>1-exp(-(u²+v²)/(2*σ²))</code>, where <code>σ</code> is the tapering parameter. This can be set with <code>--short-baseline-sigma</code>, and defaults to 40λ.</p>
<h2 id="source-counts"><a class="header" href="#source-counts">Source Counts</a></h2>
<p>Similar to <a href="../vis_subtract/intro.html"><code>vis-subtract</code></a>, the total number of sources in the sky model to be subtracted is limited by <code>--num-sources</code>, but only the top <code>--iono-sub</code> brightest have their ionospheric constants measured and modeled during subtraction. By default, hyperdrive will include sources in the sky model after <a href="../vis_simulate/intro.html#vetoing">vetoing</a> if <code>--num-sources</code> is not specified, and will ionospherically subtract all of these sources if <code>--iono-sub</code> is not specified. An error will occur if <code>--num-sources</code> is greater than the number of sources in the sky model.</p>
<p>Future versions of peel will include a <code>--peel</code> argument to specify the number of sources to peel.</p>
<h2 id="high-level-overview"><a class="header" href="#high-level-overview">High level overview</a></h2>
<pre class="mermaid">%%{init: {'theme':'dark', 'themeVariables': {'fontsize': 20}}}%%
flowchart TD
    InputData[fa:fa-file Calibrated input data]--&gt;Args
    CalSols[fa:fa-file Sky-model source-list file]--&gt;Args
    Settings[fa:fa-cog Other settings]-.-&gt;Args

    Args[fa:fa-cog User arguments]--&gt;Valid{fa:fa-code Valid?}
    Valid --&gt; peel

    subgraph peel[For all timesteps]
        Read[&quot;fa:fa-code Read a timestep
        of input data&quot;]
        IonoConsts[&quot;fa:fa-cog Ionospheric consts
        α, β, g
        per-source, initially unknown&quot;]
        Residual[&quot;fa:fa-code Subtract for Residual&quot;]
        Model[&quot;fa:fa-code Generate
        ionospheric model vis&quot;]
        IonoConsts --&gt; Model
        Read -------&gt; Residual
        Model --&gt; Residual
        Residual --&gt; Loop
        IonoConsts --&gt; Loop
        subgraph Loop[For each source]
            Phased[&quot;fa:fa-code Phase residual to source&quot;]
            SourceModel[&quot;fa:fa-code model source&quot;]
            SourceModel &amp; Phased --&gt; Average[&quot;fa:fa-code Add source and average data&quot;]
            SourceModel &amp; Average --&gt; Fit[&quot;fa:fa-code Fit ionospheric
            model&quot;]
        end
        Fit --&gt; IonoConsts
        Residual --&gt; Write[&quot;fa:fa-save Write timeblock
        visibilities&quot;]
    end
</pre>
<h2 id="peeling"><a class="header" href="#peeling">Peeling</a></h2>
<p>A full peel involves performing direction-independent calibration towards each source, this is currently a work in progress and not yet implemented.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../user/vis_subtract/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../user/beam.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../user/vis_subtract/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../user/beam.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </div>
    </body>
</html>
